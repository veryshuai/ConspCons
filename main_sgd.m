%temporary main file for conspicuous consumption estimation
clc;
cd '/gpfs/home/dcj138/work/ConspCons/'

warning off all;

%read %create data files

load dat

%open parallel functionality
matlabpool open 6

%open diary
diary 2-4-12-sgd-1.txt

%linearly extend prices to cover zeros and include only relevant price years
price = price_fixing(price); 
price = price([1,7:12,14:24],:);

%create total expenditures
exp = sum(cons,2);

c = dataset(exp,cons,char);

%drop obs if expenditure less than one dollar/yr
ind = find(exp>1);
less_than_ones = size(exp,1) - size(ind,1);
c = c(ind,:);

%drop obs if any good has negative expenditure
neg_exps = 0;
for k = 1:29
ind = find(c.cons(:,k)>=0);
c = c(ind,:);
neg_exps = neg_exps + size(c.cons(:,k),1)-size(ind,1);
end
display(['Lost ', num2str(less_than_ones), ' expenditures less than one dollar, and further lost ', num2str(neg_exps),' negative expenditure observations']); 

%create year numbers
c.y = zeros(size(c.exp));
c.y(c.char(:,7)==80) = 1;
for k = 2:7
    c.y(c.char(:,7)==84+k) = k;
end
for k = 8:14
    c.y(c.char(:,7)==85+k) = k;
end
for k = 15:18
    c.y(c.char(:,7)==k-15) = k;
end

% create expenditure grid by year [year,grid]
gr_siz = 100;
w_b = zeros(2,18);
egr = zeros(18,gr_siz);
for k = 1:18
w_b(:,k) = quantile(c.exp(c.y==k),[.1;.9]);
egr(k,:) = logspace(log(w_b(1,k))/log(10),log(w_b(2,k))/log(10),gr_siz);
end

%create type indices
ti = zeros(size(c,1),4);
ti(:,1) = c.char(:,3)==1 & c.char(:,4) == 1; %bo4
ti(:,2) = c.char(:,3)==1 & c.char(:,4) == 0; %no4
ti(:,3) = c.char(:,3)==0 & c.char(:,4) == 1; %bu4
ti(:,4) = c.char(:,3)==0 & c.char(:,4) == 0; %nu4

%make a type variable
c.type = ti(:,1)+2*ti(:,2) +3*ti(:,3)+4*ti(:,4); 

%create two dimensional consumption array with dimensions year, type, and element expenditure level
c = sortrows(c,{'exp'});
ca = cell(18,4);
ce = cell(18,4);
for k = 1:18
    for m = 1:4
       ind = find(c.y==k & c.type==m);
        ca{k,m} = c.cons(ind,:);
        ce{k,m} = c.exp(ind);
    end
end

% find the cutoff observations in data, this is going to be a two dimensional array [year,type]
% and the elements will be the cuts 
egr_cuts = cell(18,4);
for k = 1:18
    for m = 1:4
        egr_cuts{k,m} = zeros(size(egr,2),1);
        for j=1:size(egr,2)
            egr_cuts{k,m}(j) = find(ce{k,m}>egr(k,j),1,'first');
        end
    end
end

%wealth dist calculations, matrix [density,year,type]
w = zeros(size(egr,2),18,4);
for j = 1:18
    for k = 1:4  
        w(:,j,k) = histc(ce{j,k},egr(j,:))+1e-6; %added a bit to ensure that there are no zeros (full support)
        w(:,j,k) = w(:,j,k)/sum(w(:,j,k),1); %make it a dist
    end
end

%v is literally the inverse of the vindex times grid size
v = zeros(4,29);
for k = 1:4
    v(k,:) = vin(k,:).^-1;
end

%call genetic algorithm

pop = [
       1.97412196049477,0.965125052574956,0.568689354475504,0.442017588774856,0.403943685364910,0.459356984639652,0.613203892321257,0.710724197017289,0.565362336908714,1.00746002433591,1.79393862676478,0.847283237811877,0.979106637385050,0.388198950375812,0.729938117100650,1.09561846082094,0.730617508550143,0.666083213945198,0.597419655349376,1.93171446625907,0.517478709287660,0.364870280833702,0.820715719354974,0.189883048673908,0.573328617530078,1.94280448451436,1.21161784411734,1.19609218890319,0.213439480198885,195.619400253574,332.426795896220,1702.55315875538,595.516478261836,654.260905202402,301.776679989833,104.993839162560,1237.71145545243,1131.79063181470,1743.21531922161,202.230381752333,111.045015764476,262.714416510987,959.037534731401,58.9421010079630,991.279967810166,467.592591014327,380.531068017099,1616.71241101753,1883.13188046515,442.015308903031,648.363303342143,711.962250399134,683.172029318215,784.317325575237,996.087291029308,1721.85109228803,1772.88634349306,956.847337251191;...
       %1.90492119588213,0.927064140870967,0.215599299507565,0.191073265373364,0.340393733720058,0.188197328850952,0.771525804912433,0.0946863574462257,0.0448905722337556,0.373077718312452,1.86002475971661,0.867667063085246,0.734796720931475,0.423830588052935,0.810858531249463,0.742590490863181,0.450239204613546,0.0490826014722586,0.393628460946834,1.83001143758647,0.351987321657495,0.0148900082141373,0.643756898766708,0.316769880228333,0.220001082834437,1.78744360581488,0.550415888413302,0.518568287262287,0.309941229994610,17.8053606529050,159.804238937342,106.213667775179,38.6254958548714,146.398079613840,43.3371650971671,37.0807702910396,10.8873880718423,165.570444026156,187.412867375285,110.963743960275,53.0939285277397,91.7217781341128,156.554285505562,84.0795609895534,162.179416199095,79.3535241956532,72.3216749280599,139.276973423994,62.1511641084645,44.9043365698948,10.8223804653820,67.2047139842356,118.242562059525,69.4589812423188,21.4901041616081,3.89044475388710,174.123814719692,191.003134579609;...
       %1.96189808085509,0.644318130194047,0.0286741524650774,0.343877004115639,0.236230576994560,0.406954837139500,0.897191350973675,0.0615906670549031,0.105920416733659,0.227712826027320,1.84321333801067,0.877048723385167,0.824737160856833,0.0842470523155753,0.680038640460459,0.694403909684860,0.587019167083185,0.396290248510379,0.401790917847597,1.82239400675920,0.375471662698172,0.0559525294079649,0.583132968089065,0.0347767401007119,0.384313617883229,1.67779409182310,0.523947649264085,0.476639717645144,0.242876166293867,63.8981689763060,1,66.3568745159319,45.5963946616718,21.3791501875803,131.712449768276,80.4196884092504,7.96818828054938,113.312056412094,60.3228670948682,25.4832679407941,22.6247344586362,84.4565503486008,48.2821786467453,37.0737589504604,138.019882013562,107.748497174722,117.136318313069,3.80510483235579,191.254454593063,16.2114521046035,185.668760736023,185.569621045531,92.3454564216253,64.3149775914169,73.4989358994409,156.258502367072,44.4359832150583,128.117643731999;...
       %1.99705433085509,0.769318130194047,0.0286741524650774,0.166947130744126,0.236230576994560,0.336642337139500,0.897191350973675,0.0928406670549031,0.105920416733659,0.227712826027320,1.84321333801067,0.877048723385167,0.824737160856833,0.115497052315575,0.617538640460459,0.694403909684860,0.587019167083185,0.275196498510379,0.335384667847597,1.82239400675920,0.375471662698172,0.0559525294079649,0.645632968089065,0.0855579901007119,0.384313617883229,1.86529409182310,0.523947649264085,0.476639717645144,0.242876166293867,62.8981689763060,1.04296875000000,66.3568745159319,45.5963946616718,21.3791501875803,132.712449768276,85.5687717251810,7.96818828054938,113.366743912094,60.3853670948682,24.5067054407941,23.6637969586362,84.9565503486008,48.2821786467453,36.5737589504604,196.780356757901,107.748497174722,117.183193313069,68.2845541873584,193.254454593063,17.2114521046035,181.380421450503,184.632121045531,92.3454564216253,64.3149775914169,73.6278421494409,156.274127367072,158.822601033852,128.164518731999;...
       %1.99314808085509,0.878693130194047,0.0286741524650774,0.191073265373364,0.236230576994560,0.406954837139500,0.897191350973675,0.0654969170549031,0.105920416733659,0.227712826027320,1.84321333801067,0.877048723385167,0.824737160856833,0.146747052315575,0.680038640460459,0.694403909684860,0.587019167083185,0.271290248510379,0.401790917847597,1.82239400675920,0.375471662698172,0.106733779407965,0.708132968089065,0.0621204901007119,0.384313617883229,1.77154409182310,0.551291399264085,0.476639717645144,0.242876166293867,61.8981689763060,2,66.3568745159319,45.0963946616718,20.8791501875803,131.712449768276,80.9353134092504,8.21818828054938,113.312056412094,61.3228670948682,25.4832679407941,23.1247344586362,48.0340375639472,48.2821786467453,37.0737589504604,146.124015358742,107.748497174722,117.214443313069,139.276973423994,193.254454593063,17.5552021046035,185.668760736023,185.612589795531,91.3454564216253,64.3149775914169,73.4989358994409,157.321002367072,46.4359832150583,128.148893731999;...
       ];

options=gaoptimset('Display','iter','PopulationSize',30,'Generations',150,... 
   'StallTimeLimit',86400,'TimeLimit',Inf,'MutationFcn',@mutationadaptfeasible,...
   'FitnessScalingFcn',@fitscalingrank,'InitialPopulation',pop,'UseParallel','always',...
   'PlotFcns',@gaplotbestf,'EliteCount',1);

    [X,fval,exitflag,output,population,scores] = ga(@(X) likelihood_sgd(X,price,egr,v,w,ca,egr_cuts),58,...
    [],[],[],[],[ones(1,29)*1e-12,ones(1,29)*1,0,5e1],[ones(1,29)*2,ones(1,29)*2000,1,5e2],[],options);  

matlabpool close
diary off



