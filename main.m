%temporary main file for conspicuous consumption estimation
clc;
cd '/gpfs/home/dcj138/work/ConspCons/'

warning off all;

%read %create data files

load dat

%open parallel functionality
%matlabpool open 6

%open diary
%diary 2-4-12.txt

%linearly extend prices to cover zeros and include only relevant price years
price = price_fixing(price); 
price = price([1,7:12,14:24],:);


%create total expenditures
exp = sum(cons,2);

c = dataset(exp,cons,char);

%drop obs if expenditure less than one dollar/yr
ind = find(exp>1);
less_than_ones = size(exp,1) - size(ind,1);
c = c(ind,:);

%drop obs if any good has negative expenditure
neg_exps = 0;
for k = 1:29
ind = find(c.cons(:,k)>=0);
c = c(ind,:);
neg_exps = neg_exps + size(c.cons(:,k),1)-size(ind,1);
end
display(['Lost ', num2str(less_than_ones), ' expenditures less than one dollar, and further lost ', num2str(neg_exps),' negative expenditure observations']); 

%create year numbers
c.y = zeros(size(c.exp));
c.y(c.char(:,7)==80) = 1;
for k = 2:7
    c.y(c.char(:,7)==84+k) = k;
end
for k = 8:14
    c.y(c.char(:,7)==85+k) = k;
end
for k = 15:18
    c.y(c.char(:,7)==k-15) = k;
end

% create expenditure grid by year [year,grid]
gr_siz = 15;
w_b = zeros(2,18);
egr = zeros(18,gr_siz);
for k = 1:18
w_b(:,k) = quantile(c.exp(c.y==k),[.1;.2]);
%egr(k,:) = logspace(log(w_b(1,k))/log(10),log(w_b(2,k))/log(10),gr_siz); %logs
egr(k,:) = linspace(w_b(1,k),w_b(2,k),gr_siz); %linear
end

%create type indices
ti = zeros(size(c,1),4);
ti(:,1) = c.char(:,3)==1 & c.char(:,4) == 1; %bo4
ti(:,2) = c.char(:,3)==1 & c.char(:,4) == 0; %no4
ti(:,3) = c.char(:,3)==0 & c.char(:,4) == 1; %bu4
ti(:,4) = c.char(:,3)==0 & c.char(:,4) == 0; %nu4

%make a type variable
c.type = ti(:,1)+2*ti(:,2) +3*ti(:,3)+4*ti(:,4); 

%create two dimensional consumption array with dimensions year, type, and element expenditure level
c = sortrows(c,{'exp'});
ca = cell(18,4);
ce = cell(18,4);
for k = 1:18
    for m = 1:4
       ind = find(c.y==k & c.type==m);
        ca{k,m} = c.cons(ind,:);
        ce{k,m} = c.exp(ind);
    end
end

% find the cutoff observations in data, this is going to be a two dimensional array [year,type]
% and the elements will be the cuts 
egr_cuts = cell(18,4);
for k = 1:18
    for m = 1:4
        egr_cuts{k,m} = zeros(size(egr,2),1);
        for j=1:size(egr,2)
            egr_cuts{k,m}(j) = find(ce{k,m}>egr(k,j),1,'first');
        end
    end
end

%wealth dist calculations, matrix [density,year,type]
% w = zeros(size(egr,2),18,4);
% for j = 1:18
%     for k = 1:4  
%         w(:,j,k) = histc(ce{j,k},egr(j,:))+1e-6; %added a bit to ensure that there are no zeros (full support)
%         w(:,j,k) = w(:,j,k)/sum(w(:,j,k),1); %make it a dist
%     end
% end

%now we need to approximate expenditures with a continuous distribution.
%I choose to fit a polynomial.
w = zeros(4,18,4);
resolution = 30; %number of grid points
freqs = zeros(resolution+1,18,4);
for j = 1:18
    ind_var = linspace(w_b(1,j),w_b(2,j),resolution+1)';
    for k = 1:4
        freqs(:,j,k) = histc(ce{j,k},ind_var);
        w(1:3,j,k) = regress(freqs(1:end-1,j,k),[ind_var(1:end-1).^0,ind_var(1:end-1).^1,ind_var(1:end-1).^2]);
        pred = [ind_var(1:end-1).^0,ind_var(1:end-1).^1,ind_var(1:end-1).^2]*w(1:3,j,k); 
        w(4,j,k) = quad(@(x) w(1,j,k) + w(2,j,k)*x + w(3,j,k)*x.^2,w_b(1,j),w_b(2,j));
    end
end



%v is literally the inverse of the vindex times grid size
v = zeros(4,29);
for k = 1:4
    v(k,:) = vin(k,:).^-1;
end

%call genetic algorithm

    pop = [
       1.9859,   0.9653,    0.5793,    0.5732,    0.4198,    0.4594,    0.6135,    0.7510,    0.5674,    1.0082,    1.7941,    0.8475,    0.9879,    0.3887,    0.7303,    1.1098,    0.7369,    0.6466,    0.6035,    1.9949,    0.5178,    0.3652,    0.8599,    0.2485,    0.6243,    1.9441,    1.2079,    1.2181,    0.2136, 195.6,	332.4,	1702.6,	595.5,	654.3	,301.8	,105	,1237.7	,1131.9	,1743.2	,202.5	,111.1	,262.7	,959.1	,58.9	,991.3	,467.7	,380.5	,1616.7	,1883.1	,442	,648.4	,712.2	,683.2	,785.4	,996.1	,1721.9	,1772.9	,957,0,200;... 
       1.9859,   0.9653,    0.5793,    0.5732,    0.4198,    0.4594,    0.6135,    0.7510,    0.5674,    1.0082,    1.7941,    0.8475,    0.9879,    0.3887,    0.7303,    1.1098,    0.7369,    0.6466,    0.6035,    1.9949,    0.5178,    0.3652,    0.8599,    0.2485,    0.6243,    1.9441,    1.2079,    1.2181,    0.2136, 195.6,	332.4,	1702.6,	595.5,	654.3	,301.8	,105	,1237.7	,1131.9	,1743.2	,202.5	,111.1	,262.7	,959.1	,58.9	,991.3	,467.7	,380.5	,1616.7	,1883.1	,442	,648.4	,712.2	,683.2	,785.4	,996.1	,1721.9	,1772.9	,957,.1,200;...
       1.9859,   0.9653,    0.5793,    0.5732,    0.4198,    0.4594,    0.6135,    0.7510,    0.5674,    1.0082,    1.7941,    0.8475,    0.9879,    0.3887,    0.7303,    1.1098,    0.7369,    0.6466,    0.6035,    1.9949,    0.5178,    0.3652,    0.8599,    0.2485,    0.6243,    1.9441,    1.2079,    1.2181,    0.2136, 195.6,	332.4,	1702.6,	595.5,	654.3	,301.8	,105	,1237.7	,1131.9	,1743.2	,202.5	,111.1	,262.7	,959.1	,58.9	,991.3	,467.7	,380.5	,1616.7	,1883.1	,442	,648.4	,712.2	,683.2	,785.4	,996.1	,1721.9	,1772.9	,957,.2,200;...
       1.9859,   0.9653,    0.5793,    0.5732,    0.4198,    0.4594,    0.6135,    0.7510,    0.5674,    1.0082,    1.7941,    0.8475,    0.9879,    0.3887,    0.7303,    1.1098,    0.7369,    0.6466,    0.6035,    1.9949,    0.5178,    0.3652,    0.8599,    0.2485,    0.6243,    1.9441,    1.2079,    1.2181,    0.2136, 195.6,	332.4,	1702.6,	595.5,	654.3	,301.8	,105	,1237.7	,1131.9	,1743.2	,202.5	,111.1	,262.7	,959.1	,58.9	,991.3	,467.7	,380.5	,1616.7	,1883.1	,442	,648.4	,712.2	,683.2	,785.4	,996.1	,1721.9	,1772.9	,957,.3,200;...
       1.9859,   0.9653,    0.5793,    0.5732,    0.4198,    0.4594,    0.6135,    0.7510,    0.5674,    1.0082,    1.7941,    0.8475,    0.9879,    0.3887,    0.7303,    1.1098,    0.7369,    0.6466,    0.6035,    1.9949,    0.5178,    0.3652,    0.8599,    0.2485,    0.6243,    1.9441,    1.2079,    1.2181,    0.2136, 195.6,	332.4,	1702.6,	595.5,	654.3	,301.8	,105	,1237.7	,1131.9	,1743.2	,202.5	,111.1	,262.7	,959.1	,58.9	,991.3	,467.7	,380.5	,1616.7	,1883.1	,442	,648.4	,712.2	,683.2	,785.4	,996.1	,1721.9	,1772.9	,957,.4,200;...
       1.9859,   0.9653,    0.5793,    0.5732,    0.4198,    0.4594,    0.6135,    0.7510,    0.5674,    1.0082,    1.7941,    0.8475,    0.9879,    0.3887,    0.7303,    1.1098,    0.7369,    0.6466,    0.6035,    1.9949,    0.5178,    0.3652,    0.8599,    0.2485,    0.6243,    1.9441,    1.2079,    1.2181,    0.2136, 195.6,	332.4,	1702.6,	595.5,	654.3	,301.8	,105	,1237.7	,1131.9	,1743.2	,202.5	,111.1	,262.7	,959.1	,58.9	,991.3	,467.7	,380.5	,1616.7	,1883.1	,442	,648.4	,712.2	,683.2	,785.4	,996.1	,1721.9	,1772.9	,957,.5,200;...
       1.9859,   0.9653,    0.5793,    0.5732,    0.4198,    0.4594,    0.6135,    0.7510,    0.5674,    1.0082,    1.7941,    0.8475,    0.9879,    0.3887,    0.7303,    1.1098,    0.7369,    0.6466,    0.6035,    1.9949,    0.5178,    0.3652,    0.8599,    0.2485,    0.6243,    1.9441,    1.2079,    1.2181,    0.2136, 195.6,	332.4,	1702.6,	595.5,	654.3	,301.8	,105	,1237.7	,1131.9	,1743.2	,202.5	,111.1	,262.7	,959.1	,58.9	,991.3	,467.7	,380.5	,1616.7	,1883.1	,442	,648.4	,712.2	,683.2	,785.4	,996.1	,1721.9	,1772.9	,957,.6,200;...
       1.9859,   0.9653,    0.5793,    0.5732,    0.4198,    0.4594,    0.6135,    0.7510,    0.5674,    1.0082,    1.7941,    0.8475,    0.9879,    0.3887,    0.7303,    1.1098,    0.7369,    0.6466,    0.6035,    1.9949,    0.5178,    0.3652,    0.8599,    0.2485,    0.6243,    1.9441,    1.2079,    1.2181,    0.2136, 195.6,	332.4,	1702.6,	595.5,	654.3	,301.8	,105	,1237.7	,1131.9	,1743.2	,202.5	,111.1	,262.7	,959.1	,58.9	,991.3	,467.7	,380.5	,1616.7	,1883.1	,442	,648.4	,712.2	,683.2	,785.4	,996.1	,1721.9	,1772.9	,957,.7,200;...
       1.9859,   0.9653,    0.5793,    0.5732,    0.4198,    0.4594,    0.6135,    0.7510,    0.5674,    1.0082,    1.7941,    0.8475,    0.9879,    0.3887,    0.7303,    1.1098,    0.7369,    0.6466,    0.6035,    1.9949,    0.5178,    0.3652,    0.8599,    0.2485,    0.6243,    1.9441,    1.2079,    1.2181,    0.2136, 195.6,	332.4,	1702.6,	595.5,	654.3	,301.8	,105	,1237.7	,1131.9	,1743.2	,202.5	,111.1	,262.7	,959.1	,58.9	,991.3	,467.7	,380.5	,1616.7	,1883.1	,442	,648.4	,712.2	,683.2	,785.4	,996.1	,1721.9	,1772.9	,957,.1,400;...
       1.9859,   0.9653,    0.5793,    0.5732,    0.4198,    0.4594,    0.6135,    0.7510,    0.5674,    1.0082,    1.7941,    0.8475,    0.9879,    0.3887,    0.7303,    1.1098,    0.7369,    0.6466,    0.6035,    1.9949,    0.5178,    0.3652,    0.8599,    0.2485,    0.6243,    1.9441,    1.2079,    1.2181,    0.2136, 195.6,	332.4,	1702.6,	595.5,	654.3	,301.8	,105	,1237.7	,1131.9	,1743.2	,202.5	,111.1	,262.7	,959.1	,58.9	,991.3	,467.7	,380.5	,1616.7	,1883.1	,442	,648.4	,712.2	,683.2	,785.4	,996.1	,1721.9	,1772.9	,957,.2,400;...
       1.9859,   0.9653,    0.5793,    0.5732,    0.4198,    0.4594,    0.6135,    0.7510,    0.5674,    1.0082,    1.7941,    0.8475,    0.9879,    0.3887,    0.7303,    1.1098,    0.7369,    0.6466,    0.6035,    1.9949,    0.5178,    0.3652,    0.8599,    0.2485,    0.6243,    1.9441,    1.2079,    1.2181,    0.2136, 195.6,	332.4,	1702.6,	595.5,	654.3	,301.8	,105	,1237.7	,1131.9	,1743.2	,202.5	,111.1	,262.7	,959.1	,58.9	,991.3	,467.7	,380.5	,1616.7	,1883.1	,442	,648.4	,712.2	,683.2	,785.4	,996.1	,1721.9	,1772.9	,957,.3,400;...
       1.9859,   0.9653,    0.5793,    0.5732,    0.4198,    0.4594,    0.6135,    0.7510,    0.5674,    1.0082,    1.7941,    0.8475,    0.9879,    0.3887,    0.7303,    1.1098,    0.7369,    0.6466,    0.6035,    1.9949,    0.5178,    0.3652,    0.8599,    0.2485,    0.6243,    1.9441,    1.2079,    1.2181,    0.2136, 195.6,	332.4,	1702.6,	595.5,	654.3	,301.8	,105	,1237.7	,1131.9	,1743.2	,202.5	,111.1	,262.7	,959.1	,58.9	,991.3	,467.7	,380.5	,1616.7	,1883.1	,442	,648.4	,712.2	,683.2	,785.4	,996.1	,1721.9	,1772.9	,957,.4,400;...
       1.9859,   0.9653,    0.5793,    0.5732,    0.4198,    0.4594,    0.6135,    0.7510,    0.5674,    1.0082,    1.7941,    0.8475,    0.9879,    0.3887,    0.7303,    1.1098,    0.7369,    0.6466,    0.6035,    1.9949,    0.5178,    0.3652,    0.8599,    0.2485,    0.6243,    1.9441,    1.2079,    1.2181,    0.2136, 195.6,	332.4,	1702.6,	595.5,	654.3	,301.8	,105	,1237.7	,1131.9	,1743.2	,202.5	,111.1	,262.7	,959.1	,58.9	,991.3	,467.7	,380.5	,1616.7	,1883.1	,442	,648.4	,712.2	,683.2	,785.4	,996.1	,1721.9	,1772.9	,957,.5,400;...
       1.9859,   0.9653,    0.5793,    0.5732,    0.4198,    0.4594,    0.6135,    0.7510,    0.5674,    1.0082,    1.7941,    0.8475,    0.9879,    0.3887,    0.7303,    1.1098,    0.7369,    0.6466,    0.6035,    1.9949,    0.5178,    0.3652,    0.8599,    0.2485,    0.6243,    1.9441,    1.2079,    1.2181,    0.2136, 195.6,	332.4,	1702.6,	595.5,	654.3	,301.8	,105	,1237.7	,1131.9	,1743.2	,202.5	,111.1	,262.7	,959.1	,58.9	,991.3	,467.7	,380.5	,1616.7	,1883.1	,442	,648.4	,712.2	,683.2	,785.4	,996.1	,1721.9	,1772.9	,957,.6,400;...
       1.9859,   0.9653,    0.5793,    0.5732,    0.4198,    0.4594,    0.6135,    0.7510,    0.5674,    1.0082,    1.7941,    0.8475,    0.9879,    0.3887,    0.7303,    1.1098,    0.7369,    0.6466,    0.6035,    1.9949,    0.5178,    0.3652,    0.8599,    0.2485,    0.6243,    1.9441,    1.2079,    1.2181,    0.2136, 195.6,	332.4,	1702.6,	595.5,	654.3	,301.8	,105	,1237.7	,1131.9	,1743.2	,202.5	,111.1	,262.7	,959.1	,58.9	,991.3	,467.7	,380.5	,1616.7	,1883.1	,442	,648.4	,712.2	,683.2	,785.4	,996.1	,1721.9	,1772.9	,957,.7,400;...
       1.9859,   0.9653,    0.5793,    0.5732,    0.4198,    0.4594,    0.6135,    0.7510,    0.5674,    1.0082,    1.7941,    0.8475,    0.9879,    0.3887,    0.7303,    1.1098,    0.7369,    0.6466,    0.6035,    1.9949,    0.5178,    0.3652,    0.8599,    0.2485,    0.6243,    1.9441,    1.2079,    1.2181,    0.2136, 195.6,	332.4,	1702.6,	595.5,	654.3	,301.8	,105	,1237.7	,1131.9	,1743.2	,202.5	,111.1	,262.7	,959.1	,58.9	,991.3	,467.7	,380.5	,1616.7	,1883.1	,442	,648.4	,712.2	,683.2	,785.4	,996.1	,1721.9	,1772.9	,957,.1,800;...
       1.9859,   0.9653,    0.5793,    0.5732,    0.4198,    0.4594,    0.6135,    0.7510,    0.5674,    1.0082,    1.7941,    0.8475,    0.9879,    0.3887,    0.7303,    1.1098,    0.7369,    0.6466,    0.6035,    1.9949,    0.5178,    0.3652,    0.8599,    0.2485,    0.6243,    1.9441,    1.2079,    1.2181,    0.2136, 195.6,	332.4,	1702.6,	595.5,	654.3	,301.8	,105	,1237.7	,1131.9	,1743.2	,202.5	,111.1	,262.7	,959.1	,58.9	,991.3	,467.7	,380.5	,1616.7	,1883.1	,442	,648.4	,712.2	,683.2	,785.4	,996.1	,1721.9	,1772.9	,957,.2,800;...
       1.9859,   0.9653,    0.5793,    0.5732,    0.4198,    0.4594,    0.6135,    0.7510,    0.5674,    1.0082,    1.7941,    0.8475,    0.9879,    0.3887,    0.7303,    1.1098,    0.7369,    0.6466,    0.6035,    1.9949,    0.5178,    0.3652,    0.8599,    0.2485,    0.6243,    1.9441,    1.2079,    1.2181,    0.2136, 195.6,	332.4,	1702.6,	595.5,	654.3	,301.8	,105	,1237.7	,1131.9	,1743.2	,202.5	,111.1	,262.7	,959.1	,58.9	,991.3	,467.7	,380.5	,1616.7	,1883.1	,442	,648.4	,712.2	,683.2	,785.4	,996.1	,1721.9	,1772.9	,957,.3,800;...
       1.9859,   0.9653,    0.5793,    0.5732,    0.4198,    0.4594,    0.6135,    0.7510,    0.5674,    1.0082,    1.7941,    0.8475,    0.9879,    0.3887,    0.7303,    1.1098,    0.7369,    0.6466,    0.6035,    1.9949,    0.5178,    0.3652,    0.8599,    0.2485,    0.6243,    1.9441,    1.2079,    1.2181,    0.2136, 195.6,	332.4,	1702.6,	595.5,	654.3	,301.8	,105	,1237.7	,1131.9	,1743.2	,202.5	,111.1	,262.7	,959.1	,58.9	,991.3	,467.7	,380.5	,1616.7	,1883.1	,442	,648.4	,712.2	,683.2	,785.4	,996.1	,1721.9	,1772.9	,957,.4,800;...
       ];
   
options=gaoptimset('Display','iter','PopulationSize',30,'Generations',150,... 
   'StallTimeLimit',86400,'TimeLimit',Inf,'MutationFcn',@mutationadaptfeasible,...
   'FitnessScalingFcn',@fitscalingrank,'InitialPopulation',pop,'UseParallel','always',...
   'PlotFcns',@gaplotbestf,'EliteCount',1);

    [X,fval,exitflag,output,population,scores] = ga(@(X) likelihood(X,price,egr,v,w,ca,egr_cuts),60,...
    [],[],[],[],[ones(1,29)*1e-12,ones(1,29)*1,0,5e1],[ones(1,29)*2,ones(1,29)*2000,1,5e2],[],options);  

matlabpool close
diary off



